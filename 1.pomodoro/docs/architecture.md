# アーキテクチャドキュメント

このドキュメントは、ポモドーロタイマーアプリケーションの現在のアーキテクチャを記載しています。

## 目次

- [概要](#概要)
- [システム構成](#システム構成)
- [アプリケーション構造](#アプリケーション構造)
- [データフロー](#データフロー)
- [技術スタック](#技術スタック)
- [デザインパターン](#デザインパターン)

## 概要

ポモドーロタイマーは、Flask ベースのシンプルなWebアプリケーションです。モノリシックな単一ファイルアーキテクチャを採用しており、バックエンド（Flask）とフロントエンド（バニラJavaScript）が疎結合で連携しています。

**主要な特徴**
- 単一の `app.py` ファイルにすべてのバックエンドロジックを集約
- REST API を通じたフロントエンド・バックエンド通信
- ファイルベースのデータ永続化（JSON）
- ステートレスなリクエスト処理

## システム構成

````
┌─────────────────────────────────────────────────┐
│              ブラウザ（クライアント）              │
│                                                 │
│  ┌──────────────────────────────────────────┐  │
│  │         index.html (UI)                  │  │
│  │  - タイマー表示                           │  │
│  │  - 設定画面                               │  │
│  │  - 統計グラフ                             │  │
│  │  - ゲーミフィケーション表示                │  │
│  └──────────────────────────────────────────┘  │
│                     ↕                           │
│  ┌──────────────────────────────────────────┐  │
│  │   JavaScript（フロントエンドロジック）     │  │
│  │  - タイマー制御                           │  │
│  │  - API通信                                │  │
│  │  - DOM操作                                │  │
│  │  - パーティクルアニメーション              │  │
│  └──────────────────────────────────────────┘  │
└─────────────────────────────────────────────────┘
                     ↕ HTTP/JSON
┌─────────────────────────────────────────────────┐
│            Flask サーバー (app.py)              │
│                                                 │
│  ┌──────────────────────────────────────────┐  │
│  │         ルーティング（@app.route）        │  │
│  │  - GET  /                                │  │
│  │  - POST /api/complete                    │  │
│  │  - GET  /api/stats                       │  │
│  │  - GET  /api/settings                    │  │
│  │  - POST /api/settings                    │  │
│  └──────────────────────────────────────────┘  │
│                     ↕                           │
│  ┌──────────────────────────────────────────┐  │
│  │       ビジネスロジック（関数）            │  │
│  │  - load_user_data()                      │  │
│  │  - save_user_data()                      │  │
│  │  - calculate_level()                     │  │
│  │  - check_badges()                        │  │
│  └──────────────────────────────────────────┘  │
│                     ↕                           │
│  ┌──────────────────────────────────────────┐  │
│  │         データ永続化層（JSON）             │  │
│  │  - user_data.json                        │  │
│  │  - settings.json                         │  │
│  └──────────────────────────────────────────┘  │
└─────────────────────────────────────────────────┘
````

## アプリケーション構造

### ディレクトリ構造

````
1.pomodoro/
├── app.py                    # メインアプリケーション
├── requirements.txt          # Python依存関係
├── README.md                 # プロジェクト概要
├── pomodoro.png             # アプリケーションアイコン
├── templates/
│   └── index.html           # フロントエンドUI（HTML/CSS/JavaScript）
├── tests/
│   ├── conftest.py          # pytestフィクスチャ
│   └── test_app.py          # ユニットテスト
├── docs/                     # ドキュメント（このディレクトリ）
│   ├── api-reference.md     # API仕様
│   ├── architecture.md      # アーキテクチャ（本ドキュメント）
│   ├── data-models.md       # データモデル
│   └── frontend.md          # フロントエンド仕様
├── user_data.json           # 実行時に生成（ユーザーデータ）
└── settings.json            # 実行時に生成（設定）
````

### app.py の構造

**1. インポートと初期化**
````python
from flask import Flask, render_template, jsonify, request
from datetime import datetime, timedelta
import json
import os

app = Flask(__name__)
DATA_FILE = os.path.join(os.path.dirname(__file__), 'user_data.json')
````

**2. データアクセス関数**
- `load_user_data()`: JSONファイルからユーザーデータを読み込み
- `save_user_data(data)`: ユーザーデータをJSONファイルに保存

**3. ビジネスロジック関数**
- `calculate_level(xp)`: XPからレベルを計算
- `check_badges(data)`: 新規バッジの取得をチェック

**4. ルートハンドラ**
- `index()`: HTMLページを表示
- `complete_pomodoro()`: ポモドーロ完了処理
- `get_stats()`: 統計情報取得
- `settings()`: 設定の取得・保存

### templates/index.html の構造

**1. HTML構造**
- ヘッダー
- メインコンテンツ（2カラムグリッド）
  - タイマーセクション（左）
  - タブセクション（右）: ゲーミフィケーション、設定、統計

**2. CSS**
- CSS変数を使ったテーマシステム
- レスポンシブデザイン（768px ブレークポイント）
- カスタムアニメーション（バッジ出現、通知など）

**3. JavaScript**
- タイマーコア機能（開始、一時停止、リセット）
- API通信（fetch API）
- DOM操作とUI更新
- Canvas を使ったパーティクルアニメーション
- Web Audio API によるサウンド生成

## データフロー

### ポモドーロ完了フロー

````
1. ユーザーがタイマーを完了
   ↓
2. JavaScript が POST /api/complete を呼び出し
   ↓
3. app.py の complete_pomodoro() が実行
   ↓
4. load_user_data() でデータを読み込み
   ↓
5. 統計情報を更新
   - total_pomodoros += 1
   - xp += 25
   - level = calculate_level(xp)
   ↓
6. 日別・週別・月別統計を更新
   ↓
7. ストリークを計算・更新
   ↓
8. check_badges() で新規バッジをチェック
   ↓
9. save_user_data() でデータを保存
   ↓
10. JSONレスポンスを返却
   ↓
11. JavaScript が UIを更新
    - XP バーを更新
    - レベル表示を更新
    - 新規バッジを表示
    - 通知を表示
````

### 設定保存フロー

````
1. ユーザーが設定を変更し「保存」をクリック
   ↓
2. JavaScript が現在の設定値を収集
   ↓
3. POST /api/settings に JSON で送信
   ↓
4. app.py の settings() が実行
   ↓
5. settings.json にデータを書き込み
   ↓
6. 成功レスポンスを返却
   ↓
7. JavaScript が通知を表示
````

### 統計表示フロー

````
1. ユーザーが「統計」タブをクリック
   ↓
2. JavaScript が GET /api/stats を呼び出し
   ↓
3. app.py の get_stats() が実行
   ↓
4. load_user_data() でデータを読み込み
   ↓
5. 過去7日間の週間データを生成
   ↓
6. 過去30日間の月間データを生成
   ↓
7. JSONレスポンスを返却
   ↓
8. JavaScript がグラフを描画
   - 週間バーチャートを更新
   - 月間統計を表示
````

## 技術スタック

### バックエンド

| 技術 | バージョン | 用途 |
|-----|----------|------|
| Python | 3.8以上 | プログラミング言語 |
| Flask | 3.0.0 | Webフレームワーク |
| Flask-CORS | 4.0.0 | CORSサポート |

### フロントエンド

| 技術 | 用途 |
|-----|------|
| HTML5 | マークアップ |
| CSS3 | スタイリング |
| Vanilla JavaScript | ロジック・DOM操作 |
| Canvas API | パーティクルアニメーション |
| Web Audio API | サウンド生成 |

### テスト

| 技術 | バージョン | 用途 |
|-----|----------|------|
| pytest | 7.4.3 | テストフレームワーク |
| pytest-flask | 1.3.0 | Flask統合テスト |

### データストレージ

| 技術 | 用途 |
|-----|------|
| JSON | データ永続化 |

## デザインパターン

### 1. モノリシックアーキテクチャ

すべてのバックエンドロジックが `app.py` に集約されています。小規模なアプリケーションのため、レイヤー分離は行われていません。

**利点**
- シンプルで理解しやすい
- デプロイが容易
- オーバーヘッドが少ない

**制約**
- スケーラビリティに限界
- コードの再利用性が低い
- テストの分離が難しい場合がある

### 2. REST API

バックエンドとフロントエンドは REST API を介して通信します。JSON形式でデータをやり取りします。

**エンドポイント設計**
- リソース指向（`/api/stats`, `/api/settings`）
- HTTPメソッドによる操作の区別（GET/POST）
- JSON形式のリクエスト・レスポンス

### 3. ファイルベースストレージ

データベースを使用せず、JSONファイルに直接読み書きします。

**実装**
- `user_data.json`: ユーザー統計とゲーミフィケーションデータ
- `settings.json`: ユーザー設定

**特徴**
- 同期的な読み書き
- ファイルロック機構なし（単一ユーザー想定）
- トランザクション非対応

**制約**
- 並行アクセスに非対応
- 大量データには不向き
- データ整合性保証が弱い

### 4. サーバーサイドレンダリング（SSR）+ SPA

- メインページ（`/`）は Flask が SSR でレンダリング
- その後、JavaScript が動的にコンテンツを更新（SPA的な挙動）
- ページリロードなしで API 通信とUI更新を実行

### 5. 関数型プログラミング的アプローチ

ビジネスロジック関数（`calculate_level`, `check_badges`）は純粋関数に近い設計になっています。

**例: calculate_level**
````python
def calculate_level(xp):
    """XPからレベルを計算"""
    return xp // 100 + 1
````

- 副作用なし
- 入力に対して決定的な出力
- テストが容易

## スケーラビリティの考慮事項

### 現在の制約

1. **単一ユーザー想定**: 認証機能なし、データは共有される
2. **ファイルベースストレージ**: 並行アクセスに非対応
3. **ステートフルなファイル操作**: ファイルロックなし
4. **メモリ内処理**: 統計計算はすべてメモリ上で実行

### 将来のスケーリング戦略

1. **データベース導入**
   - SQLite → PostgreSQL / MySQL
   - ORMの採用（SQLAlchemy）
   - トランザクション管理

2. **認証・認可**
   - ユーザー登録・ログイン機能
   - JWTベースの認証
   - セッション管理

3. **レイヤー分離**
   - models/ - データモデル
   - repositories/ - データアクセス層
   - services/ - ビジネスロジック層
   - routes/ - ルーティング層

4. **キャッシング**
   - Redis導入
   - 統計データのキャッシング
   - セッション管理

5. **非同期処理**
   - Celery導入
   - バックグラウンドタスク（統計集計など）

## セキュリティ考慮事項

### 現在の状態

- **認証なし**: 誰でもアクセス可能
- **入力検証なし**: APIリクエストのバリデーションが不十分
- **CORS設定**: Flask-CORSがインストールされているが、明示的な設定はコード上にない
- **デバッグモード**: 環境変数 `FLASK_ENV=development` で制御

### 推奨される改善

1. 入力バリデーションの追加
2. CSRF トークンの実装
3. レート制限の導入
4. HTTPSの強制
5. セキュアなセッション管理

## パフォーマンス考慮事項

### 現在の実装

- **同期I/O**: ファイル読み書きは同期的
- **全データロード**: 統計取得時に全データをメモリにロード
- **リアルタイム計算**: 統計データは毎回計算される

### 最適化の機会

1. **非同期I/O**: async/await の導入
2. **キャッシング**: 頻繁にアクセスされるデータのキャッシュ
3. **インクリメンタル更新**: 統計の差分更新
4. **遅延ロード**: 必要なデータのみをロード

## テストアーキテクチャ

### 現在のテスト構造

- **conftest.py**: pytest フィクスチャ（app, client）
- **test_app.py**: ユニットテストとインテグレーションテスト

### テスト戦略

1. **ユニットテスト**: ビジネスロジック関数のテスト
   - `calculate_level()`
   - `check_badges()`

2. **APIテスト**: エンドポイントの動作検証
   - `test_api_complete()`
   - `test_api_stats()`
   - `test_api_settings_get()`
   - `test_api_settings_post()`

3. **インテグレーションテスト**: エンドツーエンドのフロー検証
   - ポモドーロ完了フロー全体

### テストカバレッジ

- ビジネスロジック: 高カバレッジ
- APIエンドポイント: 高カバレッジ
- エラーハンドリング: 低カバレッジ（改善の余地）

## デプロイメント

### 開発環境

````bash
python app.py
# http://localhost:5000
````

### 本番環境への考慮事項

1. **WSGI サーバーの使用**
   - Gunicorn または uWSGI
   - Flask の開発サーバーは本番非推奨

2. **環境変数**
   - `FLASK_ENV=production`
   - デバッグモードを無効化

3. **リバースプロキシ**
   - Nginx または Apache
   - SSL/TLS 終端

4. **プロセス管理**
   - systemd または supervisord
   - 自動再起動

## まとめ

ポモドーロタイマーは、シンプルなモノリシックアーキテクチャを採用したWebアプリケーションです。小規模なプロジェクトには適していますが、マルチユーザー対応やスケーラビリティを考慮する場合は、データベース導入、レイヤー分離、認証機能の追加などの改善が必要です。
